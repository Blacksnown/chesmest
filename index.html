<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C√¢y Th√¥ng Noel Nh·∫•p Nh√°y</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="sparkle-bg" aria-hidden="true"></div>
    <div class="tree">
      <div class="star">‚òÖ</div>
      <div class="light light1"></div>
      <div class="light light2"></div>
      <div class="light light3"></div>
      <div class="trunk"></div>
    </div>

    <!-- Tuy·∫øt -->
    <div class="snow"></div>
    <div class="snow"></div>
    <div class="snow"></div>
    <div class="snow"></div>
    <div class="snow"></div>
    <div class="snow"></div>

    <div class="tree">
      <div class="star">‚òÖ</div>

      <div class="layer"></div>
      <div class="layer"></div>
      <div class="layer"></div>

      <div class="trunk"></div>

      <!-- ƒê√®n -->
      <div
        class="light"
        style="top: 60rem; left: -20rem; background: red"
      ></div>
      <div
        class="light"
        style="top: 90rem; left: 20rem; background: yellow"
      ></div>
      <div
        class="light"
        style="top: 130rem; left: -40rem; background: blue"
      ></div>
      <div
        class="light"
        style="top: 160rem; left: 40rem; background: purple"
      ></div>
      <div
        class="light"
        style="top: 200rem; left: -60rem; background: orange"
      ></div>
      <div
        class="light"
        style="top: 230rem; left: 60rem; background: cyan"
      ></div>
    </div>
    <div id="ascii-tree-container" aria-label="ASCII tree"></div>

    <div class="controls">
      <label for="tree-size" class="visually-hidden">K√≠ch th∆∞·ªõc c√¢y</label>
      <select id="tree-size" class="control" aria-label="K√≠ch th∆∞·ªõc c√¢y">
        <option value="small">C√¢y nh·ªè</option>
        <option value="large">C√¢y l·ªõn</option>
      </select>
      <label for="tree-style" class="visually-hidden">Ki·ªÉu c√¢y</label>
      <select id="tree-style" class="control" aria-label="Ki·ªÉu c√¢y">
        <option value="ascii">ASCII</option>
        <option value="fancy">Fancy (ƒë·∫πp)</option>
      </select>
      <button id="toggle-lights" class="control">T·∫Øt ƒë√®n</button>
      <div class="zoom-controls" aria-hidden="false">
        <button id="zoom-out" class="control" title="Thu nh·ªè">‚àí</button>
        <input id="zoom-range" type="range" min="12" max="45" value="28" />
        <button id="zoom-in" class="control" title="Ph√≥ng to">+</button>
      </div>
    </div>

    <!--     L·ªùi ch√∫c -->
    <div class="message">
      <p>üéÑ Gi√°ng Sinh an l√†nh, H√† My y√™u d·∫•u!</p>
      <p>‚ú® Anh h·ª©a s·∫Ω m√£i y√™u th∆∞∆°ng v√† che ch·ªü cho em.</p>
      <p>üíñ D√π m√πa ƒë√¥ng l·∫°nh gi√°, tr√°i tim anh lu√¥n ·∫•m √°p v√¨ c√≥ em.</p>
    </div>
    <script type="module">
      import {
        smallTree,
        largeTree,
        renderTree,
        renderFancyTree,
      } from "./tree.js";

      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("ascii-tree-container");
        // helper to render based on style & size
        const styleSelect = document.getElementById("tree-style");
        const sizeSelect = document.getElementById("tree-size");

        function renderCurrent() {
          const style = styleSelect?.value || "ascii";
          const size = sizeSelect?.value || "small";
          if (style === "fancy") {
            // render the CSS/DOM fancy tree
            renderFancyTree(container, { size });
          } else {
            const data = size === "large" ? largeTree : smallTree;
            renderTree(container, { className: "ascii-tree", data });
          }
          // reapply zoom to newly rendered tree
          setZoom(Number(zoomRange?.value || 28));
        }

        // wire selectors
        sizeSelect?.addEventListener("change", renderCurrent);
        styleSelect?.addEventListener("change", renderCurrent);

        // Toggle blinking lights (pause/resume)
        const btn = document.getElementById("toggle-lights");
        btn?.addEventListener("click", () => {
          document.querySelectorAll(".light").forEach((el) => {
            const paused = el.classList.toggle("paused");
            if (paused) el.style.animationPlayState = "paused";
            else el.style.animationPlayState = "";
          });
          if (btn.textContent?.trim() === "T·∫Øt ƒë√®n")
            btn.textContent = "B·∫≠t ƒë√®n";
          else btn.textContent = "T·∫Øt ƒë√®n";
        });

        // Zoom controls for the ASCII tree
        const pre = document.querySelector(".ascii-tree");
        const zoomRange = document.getElementById("zoom-range");
        const zoomIn = document.getElementById("zoom-in");
        const zoomOut = document.getElementById("zoom-out");
        function setZoom(px) {
          const asciiEl = document.querySelector(".ascii-tree");
          const fancyEl = document.querySelector(".fancy-wrapper");
          if (asciiEl) {
            asciiEl.style.fontSize = px + "px";
          }
          if (fancyEl) {
            // scale fancy wrapper
            const scale = px / 28; // base 28
            fancyEl.style.transform = `scale(${scale})`;
          }
          if (zoomRange) zoomRange.value = px;
        }
        zoomIn?.addEventListener("click", () => {
          const v = Math.min(56, Number(zoomRange.value) + 2);
          setZoom(v);
        });
        zoomOut?.addEventListener("click", () => {
          const v = Math.max(12, Number(zoomRange.value) - 2);
          setZoom(v);
        });
        zoomRange?.addEventListener("input", (e) => {
          setZoom(e.target.value);
        });
        // compute a responsive zoom value based on viewport width
        let _autoZoom = Number(zoomRange?.value || 28);
        function computeResponsiveZoom() {
          const w = window.innerWidth || document.documentElement.clientWidth;
          if (w < 420) return Math.max(12, Math.round(w / 28));
          if (w < 900) return Math.max(16, Math.round(w / 32));
          return Number(zoomRange?.value || 28);
        }

        // allow user interaction to override automatic resizing
        let userAdjusted = false;
        zoomRange?.addEventListener("input", () => (userAdjusted = true));
        zoomIn?.addEventListener("click", () => (userAdjusted = true));
        zoomOut?.addEventListener("click", () => (userAdjusted = true));

        // apply initial auto zoom, but respect if range already changed
        _autoZoom = computeResponsiveZoom();
        if (!userAdjusted) {
          if (zoomRange) zoomRange.value = _autoZoom;
          setZoom(_autoZoom);
        }
        renderCurrent();

        // on resize, update zoom only if user hasn't adjusted manually
        let resizeTimer;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(() => {
            const newAuto = computeResponsiveZoom();
            if (!userAdjusted && newAuto !== _autoZoom) {
              _autoZoom = newAuto;
              if (zoomRange) zoomRange.value = _autoZoom;
              setZoom(_autoZoom);
            }
            // also recreate sparkles for nicer distribution
            createSparkles(60);
          }, 120);
        });

        // create twinkling background lights
        function createSparkles(count = 60) {
          const bg = document.getElementById("sparkle-bg");
          if (!bg) return;
          // clear any existing
          bg.innerHTML = "";
          for (let i = 0; i < count; i++) {
            const s = document.createElement("span");
            s.className = "sparkle";
            const size = Math.round(6 + Math.random() * 18);
            const left = Math.random() * 100;
            const top = Math.random() * 100;
            const delay = (Math.random() * 5).toFixed(2);
            const duration = 2 + Math.random() * 4;
            s.style.width = size + "px";
            s.style.height = size + "px";
            s.style.left = left + "%";
            s.style.top = top + "%";
            s.style.animationDelay = delay + "s";
            s.style.animationDuration = duration + "s";
            // tint - subtle color variations
            const hue = 40 + Math.round(Math.random() * 120);
            s.style.background = `radial-gradient(circle at 30% 30%, rgba(255,255,220,0.95), rgba(255,255,220,0.7) 30%, rgba(0,0,0,0) 60%), hsl(${hue} 90% 65% / 0.55)`;
            bg.appendChild(s);
          }
        }

        // create initial sparkles and recreate on resize for nicer distribution
        createSparkles(70);
        window.addEventListener("resize", () => createSparkles(60));
      });
    </script>
  </body>
</html>
